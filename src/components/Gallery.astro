---
import SectionContainer from "./SectionContainer.astro";
import { Image } from "astro:assets";

// 1. Load semua gambar (Eager loading agar aman)
const imageFiles = import.meta.glob(
    "/src/assets/gallery/*.{jpeg,jpg,png,gif,JPG,JPEG}",
    {
        eager: true,
    },
);
const galleryImages = Object.values(imageFiles).map((img: any) => img.default);
---

<div class="bg-primary-cream-dark">
    <SectionContainer id="gallery">
        <div class="text-center mb-8" data-aos="fade-up">
            <p class="section-subtitle">Momen Bahagia Kami</p>
            <h2 class="section-title" style="font-family: var(--font-serif);">
                Galeri
            </h2>
            <div class="ornament-divider">...</div>
        </div>

        <div
            class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4"
            id="gallery-grid"
        >
            {
                galleryImages.map((image, index) => (
                    <div
                        class="gallery-item cursor-pointer relative group overflow-hidden rounded-lg aspect-square shadow-md"
                        data-aos="zoom-in"
                        data-aos-delay={index * 100}
                        data-gallery-index={index}
                        data-full-src={image.src}
                    >
                        <Image
                            src={image}
                            alt={`Gallery moment ${index + 1}`}
                            width={400}
                            quality={80}
                            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                        />

                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-300" />
                    </div>
                ))
            }
        </div>
    </SectionContainer>
</div>

<!-- Lightbox Modal -->
<div
    id="lightbox-modal"
    class="fixed inset-0 z-[200] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300"
    role="dialog"
    aria-modal="true"
    aria-label="Image preview"
>
    <div
        id="lightbox-backdrop"
        class="absolute inset-0 bg-black/90 backdrop-blur-sm"
    >
    </div>

    <!-- Close Button -->
    <button
        id="lightbox-close"
        class="absolute top-4 right-4 z-50 w-10 h-10 rounded-full bg-accent-gold text-white flex items-center justify-center hover:bg-accent-gold-dark transition-colors duration-200 shadow-lg cursor-pointer"
        aria-label="Close preview"
    >
        <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
    </button>

    <!-- Prev Button -->
    <button
        id="lightbox-prev"
        class="absolute left-3 md:left-6 z-50 w-10 h-10 rounded-full bg-white/15 text-white flex items-center justify-center hover:bg-accent-gold/80 transition-all duration-200 backdrop-blur-sm cursor-pointer"
        aria-label="Previous image"
    >
        <svg
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
    </button>

    <!-- Next Button -->
    <button
        id="lightbox-next"
        class="absolute right-3 md:right-6 z-50 w-10 h-10 rounded-full bg-white/15 text-white flex items-center justify-center hover:bg-accent-gold/80 transition-all duration-200 backdrop-blur-sm cursor-pointer"
        aria-label="Next image"
    >
        <svg
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
        >
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </button>

    <!-- Image Container -->
    <div
        id="lightbox-image-container"
        class="relative z-10 p-4 transition-transform duration-300 scale-90"
    >
        <img
            id="lightbox-image"
            src=""
            alt=""
            class="max-w-[90vw] max-h-[85vh] object-contain rounded-xl shadow-2xl select-none"
        />
    </div>

    <!-- Image counter -->
    <div
        id="lightbox-counter"
        class="absolute bottom-4 left-1/2 -translate-x-1/2 z-10 text-white/70 text-sm font-medium tracking-wider"
        style="font-family: var(--font-sans);"
    >
    </div>
</div>

<script is:inline>
    (function () {
        var modal = document.getElementById("lightbox-modal");
        var lightboxImg = document.getElementById("lightbox-image");
        var container = document.getElementById("lightbox-image-container");
        var counter = document.getElementById("lightbox-counter");
        var grid = document.getElementById("gallery-grid");

        var items = grid.querySelectorAll("[data-gallery-index]");
        var images = [];
        for (var i = 0; i < items.length; i++) {
            var el = items[i];
            var img = el.querySelector("img");
            images.push({
                src: el.getAttribute("data-full-src"),
                alt: img.alt,
            });
        }

        var currentIndex = -1;
        var isOpen = false;

        function showImage() {
            if (currentIndex < 0 || currentIndex >= images.length) return;
            lightboxImg.src = images[currentIndex].src;
            lightboxImg.alt = images[currentIndex].alt;
            counter.textContent = currentIndex + 1 + " / " + images.length;
        }

        function openLightbox(index) {
            currentIndex = index;
            isOpen = true;
            showImage();
            modal.classList.remove("opacity-0", "pointer-events-none");
            container.classList.remove("scale-90");
            container.classList.add("scale-100");
            document.body.style.overflow = "hidden";
        }

        function closeLightbox() {
            isOpen = false;
            modal.classList.add("opacity-0", "pointer-events-none");
            container.classList.remove("scale-100");
            container.classList.add("scale-90");
            document.body.style.overflow = "";
            setTimeout(function () {
                lightboxImg.src = "";
            }, 300);
        }

        function navigate(direction) {
            if (!isOpen) return;
            currentIndex =
                (currentIndex + direction + images.length) % images.length;
            showImage();
        }

        // Click gallery items
        items.forEach(function (item) {
            item.addEventListener("click", function () {
                var idx = parseInt(item.getAttribute("data-gallery-index"), 10);
                openLightbox(idx);
            });
        });

        // Close
        document
            .getElementById("lightbox-close")
            .addEventListener("click", closeLightbox);
        document
            .getElementById("lightbox-backdrop")
            .addEventListener("click", closeLightbox);

        // Prev / Next
        document
            .getElementById("lightbox-prev")
            .addEventListener("click", function (e) {
                e.stopPropagation();
                navigate(-1);
            });
        document
            .getElementById("lightbox-next")
            .addEventListener("click", function (e) {
                e.stopPropagation();
                navigate(1);
            });

        // Keyboard: ESC, ←, →
        document.addEventListener("keydown", function (e) {
            if (!isOpen) return;
            if (e.key === "Escape") closeLightbox();
            if (e.key === "ArrowLeft") navigate(-1);
            if (e.key === "ArrowRight") navigate(1);
        });

        // Touch swipe for mobile
        var touchStartX = 0;
        modal.addEventListener(
            "touchstart",
            function (e) {
                touchStartX = e.changedTouches[0].screenX;
            },
            { passive: true },
        );
        modal.addEventListener(
            "touchend",
            function (e) {
                var diff = touchStartX - e.changedTouches[0].screenX;
                if (Math.abs(diff) > 50) {
                    navigate(diff > 0 ? 1 : -1);
                }
            },
            { passive: true },
        );
    })();
</script>
